server:
  http_listen_port: 3102

positions:
  filename: /opt/epa4all/promtail/positions.yaml

clients:
#  - url: http://host.docker.internal:3100/loki/api/v1/push

  - url: https://<GRAFANA_CLOUD_USER_ID>:<API_KEY>@logs-prod-us-central1.grafana.net/loki/api/v1/push
    basic_auth:
      username: "<GRAFANA_CLOUD_USER_ID>"
      password: "<API_KEY>"

scrape_configs:
  - job_name: epa4all
    static_configs:
    - targets:
        - localhost
      labels:
        job: epa4all
        __path__: /opt/epa4all/promtail/epa4all.log
    pipeline_stages:
      - json:
          expressions:
            time: timestamp
            loggerName: loggerName
            message: message
            thread: threadName
            level: level
            exception: stackTrace
            client: servicehealth_client_id
#            mdc: mdc

#      - json:
#        source: mdc
#        expressions:
#          vauSession: vauSession
#          iccsn: iccsn
#          konnektor: konnektor
#
#      - template:
#          source: vauSession
#          template: '{{ .vauSession | default "" }}'
#
#      - template:
#          source: iccsn
#          template: '{{ .iccsn | default "" }}'
#
#      - template:
#          source: konnektor
#          template: '{{ .konnektor | default "" }}'

      - template:
          source: message
          template: '{{if .message}}{{.message | replace "\\n" "\n" }}{{end}}'

      - template:
          source: exception
          template: '{{if .exception}}{{.exception | replace "\\n" "\n" | replace "\\t" "\t" }}{{end}}'

      - labels:
          loggerName:
          message:
          thread:
          level:
          client:
          exception:
#          vauSession:
#          iccsn:
#          konnektor:
      - timestamp:
          source: time
          format: RFC3339
          location: Europe/Berlin
      - labeldrop:
          - time