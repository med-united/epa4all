/*!
 * SAP SE
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/fhir/model/r4/FHIRUtils","sap/fhir/model/r4/SubmitMode","sap/fhir/model/r4/lib/FHIRBundle","sap/fhir/model/r4/lib/FHIRBundleEntry","sap/fhir/model/r4/lib/FHIRBundleRequest","sap/fhir/model/r4/lib/FHIRBundleType","sap/fhir/model/r4/lib/RequestHandle","sap/fhir/model/r4/lib/HTTPMethod","sap/fhir/model/r4/lib/FHIRUrl","sap/base/util/each","sap/base/util/merge","sap/fhir/model/r4/lib/FHIROperationOutcome"],function(e,t,r,s,n,i,o,u,a,d,l,h,f){"use strict";var p=function(e,t,r,s,n){this._mBundleQueue={};this.oModel=t;this._sServiceUrl=e;this._aPendingRequestHandles=[];this.bCSRF=!!r;this.sPrefer=s?"return=minimal":s;this.oDefaultQueryParams=n;this._oRegex={rAmpersand:/&/g,rEquals:/\=/g,rHash:/#/g,rPlus:/\+/g}};p.prototype.submitBundle=function(e,t,r){var s=this._mBundleQueue[e];return this._sendBundle(s,t,r)};p.prototype._request=function(e,s,n,i,o,d,l,h,f,p,c){if(!t.isRequestable(s)&&!n){return undefined}var g;if(!n&&this._getGroupSubmitMode(o)!==r.Direct){var _=this._getBundleByGroup(o);var m=this._getGroupUri(o);var y=this._createBundleEntry(e,s,i,l,h,f,p,m);_.addBundleEntry(y);if(c){this._mBundleQueue[o]=_;return _}else{g=this._mBundleQueue[o];if(g&&g instanceof u){g.getRequest().abort()}g=this._sendBundle(_);this._mBundleQueue[o]=g;return g}}g=this._sendRequest(e,s,i,d,e===a.PUT||e==a.POST?l:undefined,h,f,p);return g};p.prototype._createBundleEntry=function(e,r,s,o,u,d,l,h){if(r&&r.charAt(0)==="/"){r=r.slice(1)}var f=e===a.POST?this.oModel.getBindingInfo("/"+r,undefined,false,o):this.oModel.getBindingInfo("/"+r);var p=r+(a.GET===e?this._buildQueryParameters(s,f,e):"");var c;var g;if(a.GET!==e){c=t.generateFullUrl(h,f.getResourceServerPath(),f.getResourceId(),this._sServiceUrl);g=f.getETag()}var _=new i(l,e,p,u,d,g);var m;if(e==a.POST||e==a.PUT){m=new n(c,o,_)}else{m=new n(c,undefined,_)}return m};p.prototype._sendBundle=function(e,t,r){var s=function(s,n){var i=[];var o=[];this._deleteBundleFromQueue(e.getGroupId());for(var u=0;u<s.getNumberOfBundleEntries();u++){var a=s.getBundlyEntry(u);var d=n.getRequest().responseJSON.entry[u];if(d&&d.response.status.startsWith("2")){if(d.resource){i.push(d.resource)}else if(a.getResource()){i.push(a.getResource())}a.getRequest().executeSuccessCallback(n,d,a)}else{if(d&&d.response.outcome){o.push(new f(d.response.outcome))}a.getRequest().executeErrorCallback(n,d,a)}}if(r&&o.length>0){r(n,i,o)}else if(t){t(i)}}.bind(this,e);var n=function(t,s){this._deleteBundleFromQueue(e.getGroupId());for(var n=0;n<t.getNumberOfBundleEntries();n++){var i=t.getBundlyEntry(n);i.getRequest().executeErrorCallback(s)}if(r){r(s)}}.bind(this,e);var i=this._sendRequest(a.POST,"",{},{},e.getBundleData(),s,n);i.setBundle(e);return i};p.prototype._sendRequest=function(e,r,s,n,i,o,l,h){var f=new u(h);var p=new d(r,this._sServiceUrl);var c;var g="application/json";var _=this.oModel.getBindingInfo(p.getRelativeUrlWithoutQueryParameters());if(this._isRequestTransformable(e,p)){e=a.POST;i=this._getFormData(s,_,p.getQueryParameters());c=this._sServiceUrl+"/"+p.getResourceType()+"/_search";g="application/x-www-form-urlencoded"}else{var m=p.getQueryParameters()?"":this._buildQueryParameters(s,_,e);c=r.startsWith("http")?r:this._sServiceUrl+p.getRelativeUrlWithQueryParameters()+m}n=n?n:{};n["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguageTag();n["cache-control"]="no-cache";n.Prefer=this.sPrefer;var y=function(){return this._ajax(f,{url:c,data:g=="application/json"?JSON.stringify(i):i,beforeSend:function(e,r){f.setUrl(r.url);f.setData(r.data);f.setRequest(e);f.setHeaders(r.headers);var s=[];if(r.url!==this._sServiceUrl){s=t.filterArray(this._aPendingRequestHandles,undefined,undefined,function(e){return e.getUrl()===r.url})}if(s.length>0){this._add(s[0],o,l);e.abort()}else{this.oModel.fireRequestSent(this._createEventParameters(f))}}.bind(this),headers:n,type:e,contentType:g,traditional:true},o,l)}.bind(this);if(this._isCsrfTokenRequest()){n["x-csrf-token"]="fetch";var R=t.deepClone(o);var v=t.deepClone(l);o=this._callBackForXcsrfToken.bind(this,R);l=function(e,t){v(e,t)};return y()}else if(this.bCSRF&&this.sToken){n["x-csrf-token"]=this.sToken;return y()}else{return y()}};p.prototype._callBackForXcsrfToken=function(e,t){this.sToken=this.getResponseHeaders(t.getRequest())["x-csrf-token"];e(t)};p.prototype._ajax=function(t,r,s,n){var i=e.ajax(r);if(!t.isAborted()){i.complete(function(e){this.oModel.fireRequestCompleted(this._createEventParameters(e))}.bind(this,t));this._add(t,s,n);this._aPendingRequestHandles.push(t)}return t};p.prototype._add=function(e,t,r){var s=e.getRequest();s.done(function(e){this._deleteRequestHandle(e);t(e)}.bind(this,e));s.fail(function(e){this._deleteRequestHandle(e);r(e);if(!e.isAborted()){this.oModel.fireRequestFailed(this._createEventParameters(e))}}.bind(this,e))};p.prototype._createEventParameters=function(e){return{requestHandle:e}};p.prototype._getGroupSubmitMode=function(e){return this.oModel.getGroupProperty(e,"submit")};p.prototype._getGroupUri=function(e){return this.oModel.getGroupProperty(e,"uri")};p.prototype._getBundleByGroup=function(e){var t=this._mBundleQueue[e];if(!t){t=new s(this._getBundleTypeBySubmitMode(this._getGroupSubmitMode(e)),e)}else if(t instanceof u){t=t.getBundle()}return t};p.prototype._getBundleTypeBySubmitMode=function(e){switch(e){case r.Batch:return o.Batch;case r.Transaction:return o.Transaction;default:throw new Error("Unsupported SubmitMode: "+e)}};p.prototype._deleteBundleFromQueue=function(e){delete this._mBundleQueue[e]};p.prototype._buildQueryParameters=function(e,t,r){var s;r=r?r:a.GET;e=e?e:{};if(!t){return""}if(!t.getResourceId()&&r===a.GET){e=h(e,this.oDefaultQueryParams)}if(!this._isFormatSupported(e._format)){e._format="json"}s=[];l(e,function(e,t){if(t&&Array.isArray(t)){t.forEach(function(t){s.push(this._encodePair(e,t))}.bind(this))}else if(t){s.push(this._encodePair(e,t))}}.bind(this));return"?"+s.join("&")};p.prototype._encodePair=function(e,t){return this._encode(e,true)+"="+this._encode(t,false)};p.prototype._encode=function(e,t){var r=encodeURI(e).replace(this._oRegex.rAmpersand,"%26").replace(this._oRegex.rHash,"%23").replace(this._oRegex.rPlus,"%2B");if(t){r=r.replace(this._oRegex.rEquals,"%3D")}return r};p.prototype._deleteRequestHandle=function(e){var r=t.getIndexOfValueInArray(e,this._aPendingRequestHandles);this._aPendingRequestHandles.splice(r,1)};p.prototype.destroy=function(){this._mBundleQueue={};for(var e=0;e<this._aPendingRequestHandles.length;e+=0){this._aPendingRequestHandles[e].abort()}};p.prototype.getResponseHeaders=function(e){var t={};var r=e.getAllResponseHeaders().trim();var s=r.split("\n");for(var n=0;n<s.length;n++){var i=s[n];var o=i.split(":");t[o[0]]=e.getResponseHeader(o[0])}return t};p.prototype._isFormatSupported=function(e){var t=["json","application/json","application/fhir+json"];return t.indexOf(e)>=0};p.prototype._getFormData=function(e,t,r){e=e?e:{};if(r){e=h(e,r)}if(!this._isFormatSupported(e._format)){e._format="json"}if(!t){return e}if(!t.getResourceId()){e=h(e,this.oDefaultQueryParams)}return e};p.prototype._isCsrfTokenRequest=function(){return this.bCSRF?!this.sToken:false};p.prototype._isRequestTransformable=function(e,t){return e==a.GET&&this.oModel.isSecureSearchModeEnabled()&&t.isSearchAtBaseLevel()&&!this._isCsrfTokenRequest()};return p});